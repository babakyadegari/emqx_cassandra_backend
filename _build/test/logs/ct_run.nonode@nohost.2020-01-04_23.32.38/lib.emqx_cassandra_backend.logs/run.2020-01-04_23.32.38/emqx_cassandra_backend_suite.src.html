<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<!-- autogenerated by 'erl2html2'. -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/></meta>
<title>/home/babak/stuff/smartpot/emqx-rel/_build/emqx/lib/emqx_cassandra_backend/_build/test/lib/emqx_cassandra_backend/test/emqx_cassandra_backend_SUITE.erl</title>
</head>

<body bgcolor="white" text="black" link="blue" vlink="purple" alink="red">
<pre>
<a name="1"/>    1: <b>-module</b>(emqx_cassandra_backend_SUITE).
<a name="2"/>    2: 
<a name="3"/>    3: <b>-compile</b>(export_all).
<a name="4"/>    4: 
<a name="5"/>    5: <i>%-define(PID, emqx_cassandra_backend).</i>
<a name="6"/>    6: 
<a name="7"/>    7: <b>-define</b>(APP, emqx_cassandra_backend).
<a name="8"/>    8: 
<a name="9"/>    9: <b>-include_lib</b>(&quot;emqx/include/emqx.hrl&quot;).
<a name="10"/>   10: <b>-include_lib</b>(&quot;eunit/include/eunit.hrl&quot;).
<a name="11"/>   11: <i>% -include_lib(&quot;common_test/include/ct.hrl&quot;).</i>
<a name="12"/>   12: <b>-include_lib</b>(&quot;emqx/include/emqx_mqtt.hrl&quot;).
<a name="13"/>   13: <i>%-include(&quot;emqx_mqtt.hrl&quot;)</i>
<a name="all-0"/><a name="14"/>   14: <b>all</b>() -&gt;
<a name="all-last_expr"/><a name="15"/>   15:     [{group, emqx_cassandra_backend_acl},
<a name="16"/>   16:      {group, emqx_cassandra_backend_auth},
<a name="17"/>   17:      {group, emqx_cassandra_backend_log}
<a name="18"/>   18:     ].
<a name="19"/>   19: 
<a name="groups-0"/><a name="20"/>   20: <b>groups</b>() -&gt;
<a name="groups-last_expr"/><a name="21"/>   21:      [{emqx_cassandra_backend_acl, [sequence], [check_acl]},
<a name="22"/>   22:       {emqx_cassandra_backend_auth, [sequence], [test_auth]},
<a name="23"/>   23:       {emqx_cassandra_backend_log, [sequence], [test_message]}
<a name="24"/>   24:      ].
<a name="25"/>   25: 
<a name="init_per_suite-1"/><a name="26"/>   26: <b>init_per_suite</b>(Config) -&gt;
<a name="27"/>   27:     emqx_ct_helpers:start_apps([emqx_cassandra_backend], fun set_special_configs/1),
<a name="28"/>   28:     {ok, D1} = erlcass_uuid:gen_random(),
<a name="29"/>   29:     {ok, D2} = erlcass_uuid:gen_random(),
<a name="30"/>   30:     application:set_env(?APP, dev_ids, [D1, D2]),
<a name="31"/>   31:     {ok, Hash} = application:get_env(?APP, password_hash),
<a name="32"/>   32:     cassandra_cli:register_a_query(insert_dev, &lt;&lt;&quot;insert into smartpot.mqtt_auth(id, password, is_superuser) values(?, ?, ?)&quot;&gt;&gt;),
<a name="33"/>   33:     %% mock data to DB!
<a name="34"/>   34:     PHash = emqx_passwd:hash(Hash, &quot;passwd&quot;),
<a name="35"/>   35:     cassandra_cli:query(insert_dev, [D1, PHash, 0]),
<a name="36"/>   36:     cassandra_cli:query(insert_dev, [D2, PHash, 1]),
<a name="init_per_suite-last_expr"/><a name="37"/>   37:     Config.
<a name="38"/>   38: 
<a name="end_per_suite-1"/><a name="39"/>   39: <b>end_per_suite</b>(_Config) -&gt;
<a name="40"/>   40:     %cassandra_cli:register_a_query(delete_user, &lt;&lt;&quot;delete from smartpot.user where id = ?&quot;&gt;&gt;),
<a name="41"/>   41:     %cassandra_cli:register_a_query(detele_dev, &lt;&lt;&quot;delete from smartpot.mqtt_auth where id = ?&quot;&gt;&gt;),
<a name="42"/>   42:     %cassandra_cli:query(delete_user, [P1]),
<a name="43"/>   43:     %cassandra_cli:query(delete_dev, [D1]),
<a name="44"/>   44:     %emqx_ct_helpers:stop_apps([emqx_cassandra_backend]).
<a name="end_per_suite-last_expr"/><a name="45"/>   45:     ok.
<a name="46"/>   46: 
<a name="check_acl-1"/><a name="47"/>   47: <b>check_acl</b>(_) -&gt;
<a name="48"/>   48:     {ok, [D1, D2]} = application:get_env(?APP, dev_ids),
<a name="49"/>   49:     {ok, WebServiceId} = application:get_env(?APP, webservice_client_id),
<a name="50"/>   50:     User1 = #{clientid =&gt; D1, username =&gt; D1, password =&gt; &lt;&lt;&quot;passwd&quot;&gt;&gt;, zone =&gt; external},
<a name="51"/>   51:     User2 = #{clientid =&gt; D2, username =&gt; D2, password =&gt; &lt;&lt;&quot;passwd&quot;&gt;&gt;, zone =&gt; external},
<a name="52"/>   52:     WebService = #{clientid =&gt; list_to_binary(WebServiceId), username =&gt; list_to_binary(WebServiceId),
<a name="53"/>   53:         password =&gt; &lt;&lt;&quot;dummy&quot;&gt;&gt;, zone =&gt; external},
<a name="54"/>   54:     allow = emqx_access_control:check_acl(User1, subscribe, &lt;&lt;&quot;t1/t2&quot;&gt;&gt;),
<a name="55"/>   55:     allow = emqx_access_control:check_acl(User2, subscribe, &lt;&lt;&quot;t1&quot;&gt;&gt;),
<a name="56"/>   56:     deny  = emqx_access_control:check_acl(User1, publish, &lt;&lt;&quot;t1&quot;&gt;&gt;),
<a name="57"/>   57:     allow = emqx_access_control:check_acl(User2, subscribe, &lt;&lt;D2/binary,&quot;/t1&quot;&gt;&gt;),
<a name="58"/>   58:     deny  = emqx_access_control:check_acl(User2, subscribe, &lt;&lt;D1/binary,&quot;/t1&quot;&gt;&gt;),
<a name="59"/>   59:     allow = emqx_access_control:check_acl(WebService, subscribe, &lt;&lt;D1/binary,&quot;/t1&quot;&gt;&gt;),
<a name="check_acl-last_expr"/><a name="60"/>   60: <b>    allow = emqx_access_control:check_acl</b>(WebService, publish, &lt;&lt;D1/binary,&quot;/t1&quot;&gt;&gt;).
<a name="61"/>   61: 
<a name="62"/>   62: 
<a name="test_auth-1"/><a name="63"/>   63: <b>test_auth</b>(_) -&gt;
<a name="64"/>   64:   {ok, [D1, D2]} = application:get_env(?APP, dev_ids),
<a name="65"/>   65:   {ok, WebServiceId} = application:get_env(?APP, webservice_client_id),
<a name="66"/>   66:   User1 = #{clientid =&gt; D1, username =&gt; D1, password =&gt; &lt;&lt;&quot;passwd&quot;&gt;&gt;, zone =&gt; external},
<a name="67"/>   67:   User2 = #{clientid =&gt; D2, username =&gt; D2, password =&gt; &lt;&lt;&quot;passwd&quot;&gt;&gt;, zone =&gt; external},
<a name="68"/>   68:   UserBadPass = #{clientid =&gt; D2, username =&gt; D2, password =&gt; &lt;&lt;&quot;badpasswd&quot;&gt;&gt;, zone =&gt; external},
<a name="69"/>   69:   {ok,#{is_superuser := false}} = emqx_access_control:authenticate(User1),
<a name="70"/>   70:   {ok,#{is_superuser := true}} = emqx_access_control:authenticate(User2),
<a name="71"/>   71:   {ok,#{is_superuser := true}} = emqx_access_control:authenticate(#{clientid =&gt;
<a name="72"/>   72:       list_to_binary(WebServiceId), username =&gt; list_to_binary(WebServiceId),
<a name="73"/>   73:       password =&gt; &lt;&lt;&quot;passwd&quot;&gt;&gt;, zone =&gt; external}),
<a name="74"/>   74:   BadUser = #{clientid =&gt; &lt;&lt;&quot;BADUSER&quot;&gt;&gt;, username =&gt; &lt;&lt;&quot;BADUSER&quot;&gt;&gt;, password =&gt; &lt;&lt;&quot;passwd&quot;&gt;&gt;, zone =&gt; external},
<a name="75"/>   75:   {error,badarg} = emqx_access_control:authenticate(BadUser),
<a name="test_auth-last_expr"/><a name="76"/>   76: <b>  {error,password_error} = emqx_access_control:authenticate</b>(UserBadPass).
<a name="77"/>   77: 
<a name="78"/>   78: 
<a name="test_message-1"/><a name="79"/>   79: <b>test_message</b>(_) -&gt;
<a name="80"/>   80:   {ok, [D1, _]} = application:get_env(?APP, dev_ids),
<a name="81"/>   81:   {ok, WebServiceId} = application:get_env(?APP, webservice_client_id),
<a name="82"/>   82:   {ok, Client} = emqtt:start_link([{host, &quot;localhost&quot;},
<a name="83"/>   83:                               {clientid, D1},
<a name="84"/>   84:                               {username, D1},
<a name="85"/>   85:                               {password, &lt;&lt;&quot;passwd&quot;&gt;&gt;}]),
<a name="86"/>   86:   {ok, WebService} = emqtt:start_link(
<a name="87"/>   87:                               [{host, &quot;localhost&quot;},
<a name="88"/>   88:                               {clientid, list_to_binary(WebServiceId)},
<a name="89"/>   89:                               {username, list_to_binary(WebServiceId)},
<a name="90"/>   90:                               {password, &lt;&lt;&quot;123&quot;&gt;&gt;}]),
<a name="91"/>   91:   {ok, _} = emqtt:connect(Client),
<a name="92"/>   92:   {ok, _} = emqtt:connect(WebService),
<a name="93"/>   93:   timer:sleep(10),
<a name="94"/>   94:   emqtt:subscribe(Client, &lt;&lt;D1/binary,&quot;/control&quot;&gt;&gt;, qos2),
<a name="95"/>   95:   timer:sleep(1000),
<a name="96"/>   96:   emqtt:publish(WebService, &lt;&lt;D1/binary,&quot;/control&quot;&gt;&gt;, &lt;&lt;&quot;Payload&quot;&gt;&gt;, qos2),
<a name="97"/>   97:   timer:sleep(1000),
<a name="98"/>   98:   receive
<a name="99"/>   99:       {publish, #{payload := Payload}} -&gt;
<a name="100"/>  100:           ?assertEqual(&lt;&lt;&quot;Payload&quot;&gt;&gt;, Payload)
<a name="101"/>  101:   after
<a name="102"/>  102:       1000 -&gt;
<a name="103"/>  103:           ct:fail({receive_timeout, &lt;&lt;&quot;Payload&quot;&gt;&gt;}),
<a name="104"/>  104:           ok
<a name="105"/>  105:   end,
<a name="106"/>  106:   emqtt:disconnect(Client),
<a name="test_message-last_expr"/><a name="107"/>  107: <b>  emqtt:disconnect</b>(WebService).
<a name="108"/>  108: 
<a name="set_special_configs-1"/><a name="109"/>  109: <b>set_special_configs</b>(emqx) -&gt;
<a name="110"/>  110:     application:set_env(emqx, allow_anonymous, false),
<a name="111"/>  111:     application:set_env(emqx, enable_acl_cache, false),
<a name="112"/>  112:     application:set_env(emqx, plugins_loaded_file,
<a name="113"/>  113:                           emqx_ct_helpers:deps_path(emqx, &quot;deps/emqx/test/emqx_SUITE_data/loaded_plugins&quot;));
<a name="114"/>  114: 
<a name="115"/>  115: <b>set_special_configs</b>(_App) -&gt;
<a name="set_special_configs-last_expr"/><a name="116"/>  116:     ok.
</pre>
</body>
</html>
